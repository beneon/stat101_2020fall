# 从两个角度去看方差分析

说明：
1. 平方和（sum of squares, SS)是我们常用的一种简称，指的就是类似$\sum{(...)^2}$这样的形式
2. 对于一个3组比较，每组样本量各自为$n_1, n_2, n_3$的数据，$\sum_{i=1}^k{\sum_{j=i}^{n_i}{(x_{ij}-\bar{x})^2}}$指的是$x_11,x_12,...x1n_1$各项减$\bar{x}$差的平方的和，加上$x_21,x_22,...x2n_2$各项减$\bar{x}$差的平方的和，加上...直到$x_k1,x_k2,...xkn_k$各项减$\bar{x}$差的平方的和。

## 方差的分解

1. 完全随机分组设计的方差分析

$SS_总=\sum_{i=1}^k{\sum_{j=i}^{n_i}{(x_{ij}-\bar{x})^2}}$
$=\sum_{i=1}^k{\sum_{j=i}^{n_i}{(x_{ij}-\bar{x_i}+\bar{x_i}-\bar{x})^2}}$
$=\sum{\sum{((x_{ij}-\bar{x_i})^2+2(x_{ij}-\bar{x_i})(\bar{x_i}-\bar{x})+(\bar{x_i}-\bar{x})^2)}}$
$=\sum{\sum{(x_{ij}-\bar{x_i})^2}}+\sum\sum{2(x_{ij}-\bar{x_i})(\bar{x_i}-\bar{x})}+\sum{\sum{(\bar{x_i}-\bar{x})^2}}$
对于任何一组(i=1,2,...k)，都有该组所有项减该组均值的差的和为0($\sum{(x-\bar{x})}=0$, 详见公式推导，平均值的性质)，所以上面三项中的第二项为0，于是有
$SS_总=\sum{\sum{(x_{ij}-\bar{x_i})^2}}+\sum{\sum{(\bar{x_i}-\bar{x})^2}}$

2. 分解的意义

在讲方差分解以前，我们考虑这样一个问题，假如现在有一个变量x，一个变量y，现在我们用一个模型$\hat{y}=\beta_1 x+\beta_0$来根据x对y进行估计，那么这个模型到底好不好呢？我们尝试使用各个预测值$\hat{y}$与真实值y之间的距离的平方的和（$\sum{(y-\hat{y})^2}$）来作为评判标准，当这个ss最小的时候，我们认为模型是最好的。这种办法也就是线性回归中常用的最小二乘法。

简单来说，最小二乘法就是：
1. 利用一个模型根据自变量x的值$x_1,x_2,...x_n$计算因变量y的预测值$\hat{y_1}, \hat{y_2},..., \hat{y_n}$
2. 计算$SS=\sum{(y_i-\hat{y_i})^2}$
3. 通过优化模型的参数让SS最小 

回到方差分析，考虑这样一个简单的例子：3组志愿者，n1=n2=n3=15，三组数据箱式图如下图所示
![三组数据箱式图](img/anova_f1_boxplot.png)


数据集包括三个变量：id，1至45的一个记录编号；grp：1到3，提供分组信息；score：提供分数信息。现在让我们先考虑仅仅用id作为自变量，score作为因变量，用id去预测score。当我们以id作为x轴，score作为y轴的时候，可以看到数值的分布是没有什么规律的：
![id x score](img/anova_f2_id_score.png)

于是模型没有任何可用的自变量，现在预测模型为$\hat{y}=\beta_0$, 而$SS=\sum{(y_i-\beta_0)^2}$，从平均值的性质可以知道当$\beta_0=\bar{y}$的时候SS取极小值。这个时候的SS:
$SS = \sum{(y-\bar{y})^2}$
就是不考虑任何自变量的时候得到的SS极小值，也就是在方差分析中所提到的$SS_总$

现在当我们加入分组grp这个自变量以后，对于grp=1的15个score值，使用45个分数的均值已经不能使SS取极小值了，只有取
